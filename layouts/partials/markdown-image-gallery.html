<script type="text/javascript">
var pswpElement = document.querySelectorAll('.pswp')[0];
var photos = document.querySelectorAll('.markdown>p>img');
var items = [];
var isphotoloaded = false;
var garelly;
photos.forEach(function(photo){
photo.setAttribute("style","display:none;");
photo.setAttribute("data-src",photo.getAttribute("src"));
});



var updatephoto = function(photo,item,callback){
  if(photo.getAttribute("isloaded")==true){
    callback();
  }else{
    photo.intervalid = setInterval(function () {
      if (photo.naturalWidth>0 && photo.naturalHeight>0) {
        item.w = photo.naturalWidth;
        item.h = photo.naturalHeight;
        photo.setAttribute("isloaded",true);
        clearInterval(photo.intervalid);
        callback();
      }
    }, 20);
  }
}

var updateattributes = function(dom,attributes){
  attributes.forEach(function(att){
    dom.setAttribute(att.key,att.val);
  });
}
var initgallery = function(photos,items){
// build items array
  var pid = 0;
  photos.forEach(function(photo){
    photo.setAttribute('isloaded',false);
    var patharr = photo.getAttribute("data-src").split('/');
    var thumfile = `${patharr.slice(0,patharr.length-1).join('/')}/thum_${patharr[patharr.length-1]}`;
    var anch = document.createElement("A");
    updateattributes(anch,[
      {key:'href',val:'photo.getAttribute("data-src")'},
      {key:'class',val:'photo-container'},
      {key:'data-gallery-index',val:pid}
    ]);
    var thumimg = document.createElement("IMG");
    updateattributes(thumimg,[
      {key:'src',val:thumfile},
      {key:'alt',val:photo.alt},
      {key:'data-gallery-index',val:pid}
    ]);
    pid++;
    anch.appendChild(thumimg);
    photo.parentElement.insertBefore(anch,photo);
    items.push(
      {
        msrc :thumfile,
        src: photo.getAttribute("data-src"),
         w: photo.naturalWidth,
         h: photo.naturalHeight
      });

    var options = {};
    // photo.setAttribute("src","about:blank");//prevent from loading
  });
}

// Initializes and opens PhotoSwipe
var openPhotoSwipe = function(index,items){
  options={};
  var i =  parseInt(index,10);
  options.index =i;
  updatephoto(photos[i],items[i],function(){ // wait for loaded
    gallery = new PhotoSwipe( pswpElement, PhotoSwipeUI_Default, items, options);
    gallery.listen('gettingData', function(index, item) {
    // index - index of a slide that was loaded
    // item - slide object
    updatephoto(photos[index],item,function(){return});
    });
    gallery.init();

  });

};
var onThumbnailsClick = function(e) {
  e.preventDefault();
  var eTarget = e.target;
  var index = eTarget.getAttribute('data-gallery-index');
  if(index>=0){
    openPhotoSwipe(index,eTarget.items);
  }
}
var photoswipeParseHash = function() {
    var hash = window.location.hash.substring(1),
    params = {};
    if(hash.length < 5) {
        return params;
    }
    var vars = hash.split('&');
    for (var i = 0; i < vars.length; i++) {
        if(!vars[i]) {
            continue;
        }
        var pair = vars[i].split('=');
        if(pair.length < 2) {
            continue;
        }
        params[pair[0]] = pair[1];
    }
    if(params.gid) {
        params.gid = parseInt(params.gid, 10);
    }
    return params;
};

document.addEventListener("DOMContentLoaded", function(){
  initgallery(photos,items);
  document.querySelectorAll('.photo-container').forEach(function(anch2){
    anch2.firstChild.items = items;
    anch2.addEventListener("click",onThumbnailsClick);
  });
  var hashData = photoswipeParseHash();
  if(hashData.pid && hashData.gid) {
    // updategallery(photos,items);
    openPhotoSwipe( hashData.pid , items );
  }
})
</script>
