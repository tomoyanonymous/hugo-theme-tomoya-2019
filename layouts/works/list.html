{{ define "main" }}
<div class="categories">
<input type="checkbox" id="switchtoart" name="artworks" checked>
<label for="switchtoart" class="switchtoart-label">ARTWORKS</label>
<input type="checkbox" id="switchtoclient" name="clientworks" checked>
<label for="switchtoclient" class="switchtoclient-label">CLIENTWORKS</label>
</div>
<div class="tags">
{{ range $name, $taxonomy := .Site.Taxonomies.tags }}
<input type="checkbox" class ="tagselect" id="tag-{{$name}}" checked>
<label for="tag-{{$name}}" class ="tagselect-label" data-tagname="{{$name}}" >#{{$name|upper}}</label>
<style>
  input#tag-{{$name}}:checked ~ label[data-tagname='{{$name}}']{
    background-color:#06262B;
    color:#02B2D4;
  }
</style>
{{end}}
</div>
<div id="inner" class = "flex">

    {{ range .Pages }}
      {{ partial "works/article-thum.html" .}}
    {{ end }}
  </div>
  {{$masonry := resources.Get "/js/masonry.pkgd.js"}}
    <script src="{{$masonry.Permalink}}"></script>
    <script type="text/javascript">


  const elem_whole = Array.from(document.querySelectorAll("#inner>a.masonryelem"));
  const genWholeTags = (elems) => {
    let set = new Set();
    elems.forEach(el => {
      const tags = el.dataset.tags.split(' ');
      tags.forEach(e => set.add(e))});
    return Array.from(set);
  };
  const tags_whole = genWholeTags(elem_whole);
  const categories_whole = ['artwork', 'clientwork'];

  const container = document.querySelector('#inner');
  const msnry = new Masonry(container, {
    // itemSelector: '#inner>a.masonryelem',
    columnWidth: 'a article.smallthumbnail',
    gutter: 2,
    stagger: 30,
    transitionDuration: '0.2s',
    horizontalOrder: false,
    fitWidth: true
    // initLayout: false
  });

  const filterItemsOr = (items, choices) => {
    var res = items.filter(item => choices.includes(item));
    return res.length > 0;
  };

  function updateItems(current_items, newcategories, newtags) {
    const filtered_items = elem_whole.filter(el => {
      const _tags = el.dataset.tags.split(' ');
      const _category = el.dataset.category? [el.dataset.category] : ["artwork"];//default:artwork
      return filterItemsOr(newtags, _tags) && filterItemsOr(_category, newcategories)
    });

    const compareNewAndOldItems = (cmp_fn) => {
      return elem_whole.filter(el => {
        const exist_current = current_items.includes(el);
        const exist_new = filtered_items.includes(el);
        return cmp_fn(exist_current, exist_new);
      });
    };
    const append_elems = compareNewAndOldItems((e_current, e_new) => !e_current && e_new);
    const deleting_elems = compareNewAndOldItems((e_current, e_new) => e_current && !e_new);

    console.log(append_elems.length, deleting_elems.length);

    if (append_elems.length > 0) {
      append_elems.forEach(function (el) {
        container.appendChild(el);
      });
      msnry.appended(append_elems);
      msnry.reloadItems();
    }
    msnry.remove(deleting_elems);

    setTimeout(()=>{
      msnry.layout();
    }, 500);

  }

  let artbutton = document.querySelector('#switchtoart');
  let clientbutton = document.querySelector('#switchtoclient');

  function getCurrentCategories(){
    let res = [];
    if(artbutton.checked){
      res.push("artwork");
    }
    if(clientbutton.checked){
      res.push("clientwork");
    }
    return res;
  }

  let current_items = [];
  let current_tags = tags_whole;

  const categoryListener = (e) => {
    updateItems(msnry.getItemElements(),getCurrentCategories(),current_tags);
  }
  artbutton.addEventListener("change", categoryListener);
  clientbutton.addEventListener("change", categoryListener);
  const tagbuttons = document.querySelectorAll('label.tagselect-label');

  tagbuttons.forEach(but => {
    but.addEventListener('change', e => {
      var newtags = current_tags.slice();
      if (e.target.checked) {
        newtags.push(e.target.name);
      } else {
        newtags = newtags.filter(item => item != e.target.name);
      }
      console.log(newtags);
      updateItems(msnry.getItemElements(),getCurrentCategories(),newtags);
    });
  });
  //  Initialize
  updateItems(elem_whole,categories_whole,tags_whole);

</script>
{{ end }}